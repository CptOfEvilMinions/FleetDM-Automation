# FleetDM automation with Ansible and Docker

## Generate OpenSSL keys
This project contains with a self-signed OpenSSL ceretificate which should ONLY BE used for testing. Below are instructions to make your own
1. `openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout conf/tls/<name>.key -out conf/tls/<name>.crt`

## Docker v2.2
This project has a pre-defined JWT key of `super_secret_key_here` which should ONLY BE used for testing. Below are instructions to make your own
1. `openssl rand -base64 32`
1. Copy key and paste in `conf/fleet/fleet.yml` as the value for `jwt_key`
1. `docker-compose build`
1. `docker-compose run --rm fleet fleet prepare db --config /etc/fleet/fleet.yml`
    1. Initializes Kolid database
1. `docker-compose up -d`

## Docker Swarm v3.X
1. `openssl rand -base64 32 | tr -cd '[:alnum:]' | docker secret create fleetdm-jwt-key -`
1. `openssl rand -base64 32 | tr -cd '[:alnum:]' | docker secret create mysql-root-password -`
1. `openssl rand -base64 32 | tr -cd '[:alnum:]' | docker secret create mysql-fleetdm-password -`
1. `docker stack deploy -c docker-compose-swarm.yml fleetdm`
1. `docker service logs -f fleetdm_fleet`

## Ansible
1. `vim hosts.yml` and add IP address under `[fleetdm]`
1. `vim all.yml` and set:
    1. `base_domain` - The domain for your network and the base domain of the FQDN
    1. `timezone` - OPTIONAL - Change the default timezone of UTC +0
1. `openssl rand -base64 32`
    1. Copy the output from the command
1. `vim fleetdm.yml` and set:
    1. `fleetdm_jwt` -  Set this to the random string generated by the OpenSSL command
    1. `mysql_root_password` - Set the root password for MySQL
    1. `mysql_fleetdm_password` -  Set the password for FleetDM MySQL user
1. `ansible-playbook -i hosts.ini deploy_fleetdm.yml -u <user> -K`


## Versions supported
* `Fleet FleetDM v3.5.2`
* `Ansible v2.11+`
* `Ubuntu server 20.04`

## References
* [How to do a Docker healthcheck with wget instead of curl?](https://stackoverflow.com/questions/47722898/how-to-do-a-docker-healthcheck-with-wget-instead-of-curl)
* [NGINX - Enabling Session Persistence](https://docs.nginx.com/nginx/admin-guide/load-balancer/http-load-balancer/#enabling-session-persistence)
* [Docker - restart policy](https://docs.docker.com/compose/compose-file/#restart_policy)
* [fleetdm/osquery-in-a-box](https://github.com/fleetdm/osquery-in-a-box/blob/master/docker-compose.yml)
* [docker service logs](https://docs.docker.com/engine/reference/commandline/service_logs/)
* [Use Docker Secrets With MySQL on Docker Swarm](https://blog.ruanbekker.com/blog/2017/11/23/use-docker-secrets-with-mysql-on-docker-swarm/)
* [Configuring The Fleet Binary](https://github.com/fleetdm/fleet/blob/master/docs/infrastructure/configuring-the-fleet-binary.md)